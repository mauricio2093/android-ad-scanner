name: Release CD

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      build_target:
        description: "Target platform to build"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - linux
          - windows

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-linux:
    name: Build Linux Artifact
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'linux'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends python3-tk zip

      - name: Install build deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[ui]" pyinstaller

      - name: Build (Linux)
        run: |
          chmod +x scripts/build-exe.sh
          ./scripts/build-exe.sh --mode direct --name android-ad-scanner-linux --onedir --yes --install-pyinstaller

      - name: Package artifact
        run: |
          test -d dist/android-ad-scanner-linux
          cd dist
          zip -r ../android-ad-scanner-linux.zip android-ad-scanner-linux

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-ad-scanner-linux
          path: android-ad-scanner-linux.zip
          if-no-files-found: error

  build-windows:
    name: Build Windows Artifact
    runs-on: windows-latest
    if: github.event_name == 'push' || github.event.inputs.build_target == 'all' || github.event.inputs.build_target == 'windows'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install build deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[ui]" pyinstaller

      - name: Build (Windows)
        shell: pwsh
        run: |
          ./scripts/build-exe.ps1 -Mode direct -Name android-ad-scanner-windows -OneDir -Yes -InstallPyInstaller

      - name: Package artifact
        shell: pwsh
        run: |
          if (!(Test-Path "dist/android-ad-scanner-windows")) {
            throw "No se encontro dist/android-ad-scanner-windows"
          }
          Compress-Archive -Path "dist/android-ad-scanner-windows/*" -DestinationPath "android-ad-scanner-windows.zip" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-ad-scanner-windows
          path: android-ad-scanner-windows.zip
          if-no-files-found: error

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-windows
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release-assets
          sha256sum *.zip > SHA256SUMS.txt

      - name: Publish release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            release-assets/*.zip
            release-assets/SHA256SUMS.txt
